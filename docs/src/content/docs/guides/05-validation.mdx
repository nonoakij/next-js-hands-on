---
title: 5. Server Action ã®å¼•æ•°ã®validation
description: 5. Server Action ã®å¼•æ•°ã®validation
---
import { Steps } from '@astrojs/starlight/components';
import { Aside } from '@astrojs/starlight/components';
import videoSrc from '../../assets/how-to-server-action-devtool-check.mp4';

## Server Action ã®å¼•æ•°ã® validation ã‚’è¡Œã†

Server Action ã§å—ã‘å–ã‚‹å¼•æ•°ã¯ã€ã‹ãªã‚‰ãšãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

ã¨ãã« typescript ã§å®Ÿè£…ã—ã¦ã„ã‚‹ã¨å¼•æ•°ã«å‹ãŒã‚ã‚‹ã®ã§ã€å¼•æ•°ã¯å®‰å…¨ã§ã‚ã‚‹ã¨æ€ã„ãŒã¡ã§ã™ãŒã€å®Ÿéš›ã«ã¯ãã†ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚



## å¼•æ•°ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã‚ãªã‹ã£ãŸå ´åˆã®å•é¡Œç‚¹

å®Ÿéš›ã«ã€å¼•æ•°ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã‚ãªã‹ã£ãŸå ´åˆã®å•é¡Œã‚’ä½“é¨“ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

`apps/workspace/app/actions.ts` ã«ã€ç°¡å˜ãªé–¢æ•°ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã™ã€‚

```tsx
// apps/workspace/app/actions.ts
...

export async function sum(a: number, b: number) {
  return a + b;
}
```

`apps/workspace/app/sum-button.tsx` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```bash
touch apps/workspace/app/sum-button.tsx
```

```tsx
// apps/workspace/app/sum-button.tsx
"use client";
import { sum } from "@/app/actions";
import { Button } from "@/components/ui/button";

export function SumButton() {
  return (
    <Button
      onClick={async () => {
        const res = await sum(1, 2);
        console.log(res);
      }}
    >
      è¶³ã—ç®—ã™ã‚‹
    </Button>
  );
}
```

æœ€å¾Œã«ã€`apps/workspace/app/page.tsx` ã« `<SumButton />` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff lang="tsx"
// apps/workspace/app/page.tsx
import { LoginForm } from "@/app/components/login-form";
import { SignInForm } from "@/app/components/sign-in-form";
+ import { SumButton } from '@/app/sum-button';

...

  return (
    <main className="h-dvh p-8">
+       <SumButton />
```

ã“ã‚Œã§ã€ç”»é¢ã«ã€Œè¶³ã—ç®—ã™ã‚‹ã€ã¨ã„ã†ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![è¶³ã—ç®—ã™ã‚‹ã¨ã„ã†ãƒœã‚¿ãƒ³ãŒè¿½åŠ ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒ—ãƒãƒ£](../../assets/sum-server-action.png)


ã“ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« `3` ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚


![console ã«"3"ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹](../../assets/sum-server-action-devtool.png)


ã§ã¯ã€terminal ã‹ã‚‰ã“ã® Server Action ã‚’å‘¼ã³å‡ºã—ãŸã‚‰ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã“ã‚Œã‚’ç¢ºã‹ã‚ã‚‹ãŸã‚ã«ã€devtool ã® network ã‚¿ãƒ–ã‹ã‚‰ã€server action ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ curl ã¨ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ç¢ºèªã®ä»•æ–¹ã¯å°‘ã—è¤‡é›‘ãªã®ã§å‹•ç”»ã‚’è¦‹ãªãŒã‚‰ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚
<video src={videoSrc} controls muted loop autoPlay />

<Steps>

1. devtool ã‚’é–‹ãã¾ã™

2. network ã‚¿ãƒ–ã‚’é–‹ãã¾ã™

3. ç”»é¢ã®`è¶³ã—ç®—ã™ã‚‹`ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™

4. reqeust ã‚’ç¢ºèªã—ã¾ã™

5. curl ã¨ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¾ã™

</Steps>

ã“ã“ã¾ã§ã§ã€clipboard ã« curl ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸã€‚

terminal ã«è²¼ã‚Šä»˜ã‘ã¦å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä¸‹è¨˜ã®ã‚ˆã†ãªçµæœãŒå¾—ã‚‰ã‚Œã‚‹ã¯ãšã§ã™ã€‚
```bash
0:["$@1",["development",null]]
1:3
```
ã“ã‚Œã®ã†ã¡ã€`1:3` ã® `3` ãŒã€`sum` é–¢æ•°ã®çµæœã§ã™ã€‚

ãã“ã§ã€å…ˆã»ã©ã®curlã‚’å°‘ã—å¤‰æ›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

`--data-raw` ã®éƒ¨åˆ†ã‚’ `["1","2"]` ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```diff lang="bash"
curl 'http://localhost:3000/' \

...

-  --data-raw '[1,2]'
+  --data-raw '["1","2"]'
```

çµæœã¯ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ

```bash
0:["$@1",["development",null]]
1:"12"
```

`1:"12"` ã¨ãªã‚Šã¾ã—ãŸã€‚æ–‡å­—åˆ—ã¨ã—ã¦ã® `1` ã¨ `2` ã‚’é€ã£ãŸçµæœã€`"1" + "2"`ã®çµæœã¨ã—ã¦ã€`"12"` ãŒè¿”ã£ã¦ãã¾ã—ãŸã€‚

ã‚ã‚‰ãŸã‚ã¦ã€sum ã® å¼•æ•°ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```tsx
// apps/workspace/app/actions.ts
export async function sum(a: number, b: number) {
  return a + b;
}
```

å®Ÿè£…ä¸Šã¯numberå‹ã§ã™ãŒã€å®Ÿéš›ã«ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰å¥½ããªå€¤ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

(typescript ã¯ãŸã ã®é™çš„ãªå‹ã®ç¢ºèªã‚’ã—ã¦ã„ã‚‹ã ã‘ã§ã€validationãªã©ã¯è¡Œã„ã¾ã›ã‚“ã€‚)

ä»Šå›ã¯æ–‡å­—åˆ—ãŒé€£çµã•ã‚Œã¦ã—ã¾ã†ã ã‘ã§ã—ãŸãŒã€ã“ã“ã§ DB ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãªã©ã®å‡¦ç†ã‚’è¡Œã£ã¦ã„ãŸå ´åˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ã“ã¨ã‹ã‚‰ã€å¼•æ•°ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒé‡è¦ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚


<Aside type="tip">
Server Action ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å…¨ã¦ã€`POST` ãƒ¡ã‚½ãƒƒãƒ‰ã§è¡Œã‚ã‚Œã¾ã™ã€‚
ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ˆã¯å…¨ã¦ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã® URL ã«ãªã‚Šã¾ã™ã€‚
è¤‡æ•°ã‚ã£ãŸå ´åˆã«ã¯ã€ã©ã®ã‚ˆã†ã«æŒ¯ã‚Šåˆ†ã‘ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ãã®ç­”ãˆã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®`Next-Action`ã«ã‚ã‚Šã¾ã™ã€‚

Buildæ™‚ã«ã€ãã‚Œãã‚Œã® Server Action ã«å¯¾å¿œã™ã‚‹ ID ãŒå‰²ã‚ŠæŒ¯ã‚‰ã‚Œã€
ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã«`Next-Action`ã®å€¤ã¨ã—ã¦ã€ãã® ID ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚
ãã® ID ã‚’ã‚‚ã¨ã«ã€ã©ã® Server Action ã‚’å®Ÿè¡Œã™ã‚‹ã‹ãŒæ±ºã¾ã£ã¦ã„ã¾ã™ã€‚

é€šå¸¸ã®é–‹ç™ºã§ã¯ã“ã®å€¤ã‚’æ°—ã«ã™ã‚‹å¿…è¦ã¯å…¨ãã‚ã‚Šã¾ã›ã‚“ãŒæ°—ã«ãªã‚‹æ–¹ã¯ã€
ä¸Šè¨˜ã®å‹•ç”»ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®ç¢ºèªã‚‚è¡Œã£ã¦ã„ã‚‹ã®ã§ã€å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
</Aside >

## ä»Šå›è¿½åŠ ã—ãŸå¤‰æ›´ã‚’å‰Šé™¤ã™ã‚‹ğŸ§¹
ã“ã“ã¾ã§ç¢ºèªãŒã§ããŸã‚‰ã€ä»Šå›è¿½åŠ ã—ãŸå¤‰æ›´ã¯ä¸è¦ãªã®ã§å‰Šé™¤ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

<Steps>
<ol>
  <li>
    action.ts ã‹ã‚‰ sum é–¢æ•°ã‚’å‰Šé™¤ã—ã¾ã™

    ```diff lang="tsx"
    // apps/workspace/app/actions.ts
    ...

    - export async function sum(a: number, b: number) {
    -   return a + b;
    - }
    ```
  </li>
  <li>
    sum-button.tsx ã‚’å‰Šé™¤ã—ã¾ã™

    ```bash
    rm apps/workspace/app/sum-button.tsx
    ```
  </li>
  <li>
    page.tsx ã‹ã‚‰ SumButton ã‚’å‰Šé™¤ã—ã¾ã™

    ```diff lang="tsx"
    // apps/workspace/app/page.tsx
    import { LoginForm } from "@/app/components/login-form";
    import { SignInForm } from "@/app/components/sign-in-form";
    - import { SumButton } from '@/app/sum-button';

    ...

      return (
        <main className="h-dvh p-8">
    -       <SumButton />
    ```
  </li>
</ol>
</Steps>

## å¼•æ•°ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†

å¼•æ•°ã®ãƒãƒªãƒ‡ãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€ãŠå¥½ããªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§è¡Œã†ã“ã¨ãŒã§ãã¾ã™ãŒã€ã“ã“ã§ã¯ `zod` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
ã¾ãšã¯ã€actions.ts ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†

```diff lang="tsx"
// apps/workspace/app/actions.ts
"use server";
import { cookies } from "next/headers";
import { redirect } from "next/navigation";
+ import { type inferFlattenedErrors, z } from "zod";

+ const authSchema = z.object({
+   email: z.string().email(),
+   password: z.string().min(1),
+ });

- export async function auth(formData: FormData) {
-   const email = formData.get("email") as string;
-   const password = formData.get("password") as string;
+ export async function auth(formData: FormData) {
+   const parsedFormData = authSchema.safeParse(
+     Object.fromEntries(formData.entries()),
+   );
+   if (!parsedFormData.success) {
+     throw new Error("Invalid form data", { cause:  parsedFormData.error });
+   }
+ 
+   const { email, password } = parsedFormData.data;
  const response = await fetch("http://localhost:8000/auth", {
    method: "POST",
    mode: "cors",
    headers: {
      "Content-Type": "application/json",
```

`authSchema.safeParse` ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã„ã€æˆåŠŸã—ãŸå ´åˆã¯ `parsedFormData.data` ã«ã€å¤±æ•—ã—ãŸå ´åˆã¯ `parsedFormData.error` ã«ã‚¨ãƒ©ãƒ¼æƒ…å ±ãŒæ ¼ç´ã•ã‚Œã¾ã™ã€‚
`parsedFormData.success` ã§æˆåŠŸã‹å¤±æ•—ã‹ã‚’åˆ¤å®šã§ãã¾ã™ã€‚

ã“ã®çŠ¶æ…‹ã§ã€`http://localhost:3000` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«ä¸‹è¨˜ã®ã‚ˆã†ãªå€¤ã‚’å…¥ã‚Œã¦ã¿ã¦ãã ã•ã„ã€‚
- email: `foo@example`
- password: "" // ä½•ã‚‚å…¥åŠ›ã—ãªã„

ã™ã‚‹ã¨ã€ç”»é¢ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

![ç”»é¢ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹](../../assets/validation-error.png)

ã“ã‚Œã§ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

æ¬¡ã¯ã€ç”»é¢ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

<Aside type="tip">
  æœ‰åãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ã¯ã€`zod` ã®ä»–ã«ã‚‚ `valibot`, `yup`, `Joi` ãªã©ãŒã‚ã‚Šã¾ã™ã€‚
</Aside>


## ã¾ã¨ã‚

ä»Šå›ã¯ã€Server Action ã§å¼•æ•°ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†æ–¹æ³•ã‚’å­¦ã³ã¾ã—ãŸã€‚

Server Action ã§å—ã‘å–ã‚‹å¼•æ•°ã¯ã€ã‹ãªã‚‰ãšãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

## å‚è€ƒãƒªãƒ³ã‚¯

- Next.js v14 ã§ Form validation ã‚’ server å´ã§è¡Œã†
  https://cam-inc.co.jp/p/techblog/859745503506595841
