---
title: 6. ç”»é¢ã«ã‚¨ãƒ©ãƒ¼ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹
description: 6. ç”»é¢ã«ã‚¨ãƒ©ãƒ¼ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹
---
import { Aside } from '@astrojs/starlight/components';

## ã‚¨ãƒ©ãƒ¼ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹
ã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€ã¾ãšã¯ Server Action ã‚’å¤‰æ›´ã—ã¾ã—ã‚‡ã†ã€‚

```diff lang="tsx"
// apps/workspace/app/actions.ts

export async function auth(formData: FormData) {
  const parsedFormData = authSchema.safeParse(
    Object.fromEntries(formData.entries()),
  );
  if (!parsedFormData.success) {
-    throw new Error("Invalid form data", { cause:  parsedFormData.error });
+    return parsedFormData.error.formErrors;
  }

```

ã“ã®ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€validation ã«å¤±æ•—ã—ãŸçµæœã‚’clientå´ã§å–ã‚Šæ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

æ¬¡ã«ã€ç”»é¢ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€`sign-in-form.tsx` ã‚’å¤‰æ›´ã—ã¦ã€ã‚¨ãƒ©ãƒ¼ã‚’Stateã«ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã¾ãŸã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€`use client`ã‚’ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```diff lang="tsx"
// apps/workspace/app/components/sign-up-form.tsx
+"use client";
import { auth } from "@/app/actions";
import { Button } from "@/components/ui/button";
+import { useState } from "react";

...

export function SignUpForm() {
+  const [state, setState] = useState<{
+    fieldErrors: { email?: string[]; password?: string[] }
+  }>()
+
+  const formAction = async (formData: FormData) => {
+    const res = await auth(formData)
+    if(res !== null){
+      setState(res)
+    }
+  }

  return (
-    <form action={auth}>
+    <form action={formAction}>

```

ã‚ã¨ã¯ã€ã‚¨ãƒ©ãƒ¼ã®æƒ…å ±ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```diff lang="tsx"
// apps/workspace/app/components/sign-up-form.tsx
...
      <CardContent className="space-y-2">
        <div className="space-y-1">
          <Label htmlFor="email">Email</Label>
          <Input
            id="email"
            name="email"
            type="email"
            placeholder="matsumoto_aki@example.com"
          />
+          {state?.fieldErrors.email && (
+            <p role="alert" className="text-red-500">
+              {state.fieldErrors.email}
+           </p>
+          )}
        </div>
        <div className="space-y-1">
          <Label htmlFor="password">Password</Label>
          <Input id="password" name="password" type="password" />
+          {state?.fieldErrors.password && (
+            <p role="alert" className="text-red-500">
+              {state.fieldErrors.password}
+            </p>
+          )}
        </div>
      </CardContent>
```

ã“ã“ã¾ã§å®Ÿè£…ã§ããŸã‚‰ã€`http://localhost:3000` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«ä¸‹è¨˜ã®ã‚ˆã†ãªå€¤ã‚’å…¥ã‚Œã¦ã¿ã¦ãã ã•ã„ã€‚
- email: `foo@example`
- password: "" // ä½•ã‚‚å…¥åŠ›ã—ãªã„

ä¸‹è¨˜ã®ã‚ˆã†ã«ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
![ã‚¨ãƒ©ãƒ¼è¡¨ç¤º](../../assets/validate-result-ui.png)

## çµ„ã¿è¾¼ã¿ã®Hooksã‚’åˆ©ç”¨ã—ã¦ã‚ˆã‚Šç°¡æ½”ã«æ›¸ã

`useFormState` ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ç°¡æ½”ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

`useFormState`ã‚’ä½¿ã†å‰ã«ä¸‹è¨˜ã®ã‚ˆã†ã« action ã‚’å¤‰æ›´ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
ç†ç”±ã¯å¾Œè¿°ã—ã¾ã™ã®ã§ã€ã¾ãšã¯å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

```diff lang="tsx"
// apps/workspace/app/actions.ts

const authSchema = z.object({
  email: z.string().email(),
  password: z.string().min(1),
});
+ type State = inferFlattenedErrors<typeof authSchema> | null;

- export async function auth(formData: FormData) {
+ export async function auth(state: State, formData: FormData): Promise<State> {
    const parsedFormData = authSchema.safeParse(
    Object.fromEntries(formData.entries()),
  );
  if (!parsedFormData.success) {

```

æ¬¡ã«ã€`useFormState` ã‚’åˆ©ç”¨ã™ã‚‹å½¢ã«`sign-up-form.tsx`ã‚’å¤‰æ›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```diff lang="tsx"
// apps/workspace/app/components/sign-up-form.tsx

-import { useState } from "react";
+import { useFormState } from "react-dom";

export function SignInForm() {
-  const [state, setState] = useState<{
-    fieldErrors: { email?: string[]; password?: string[] }
-  }>()
-
-  const formAction = async (formData: FormData) => {
-    const res = await auth(formData)
-    if(res !== null){
-      setState(res)
-    }
-  }
+   const [state, formAction] = useFormState(auth, null);
  return (
    <form action={formAction}>
  );
}
```

ã“ã‚Œã§ã€`useFormState` ã‚’åˆ©ç”¨ã—ã¦ã€ç°¡æ½”ã«æ›¸ãã“ã¨ãŒã§ãã¾ã—ãŸã€‚

`useFormState` ã®ç¬¬ä¸€å¼•æ•°ã«ã¯ã€action ã‚’ã€ç¬¬äºŒå¼•æ•°ã«ã¯Stateã®åˆæœŸå€¤ã‚’ã¨ã‚Šã¾ã™ã€‚
ç¬¬ä¸€å¼•æ•°ã® action ã®ç¬¬ä¸€å¼•æ•°ã«ã¯ã€ç¾åœ¨ã®Stateã‚’å—ã‘å–ã‚Šã€ç¬¬äºŒå¼•æ•°ã«ã¯ã€formã®ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€ä¸‹è¨˜ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx
const [state, formAction] = useFormState((state, formData) => {
  // æœ¬å½“ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã—ãŸã»ã†ãŒã„ã„ã§ã™ãŒã€çœç•¥
  const count = formData.get('count')
  return count + state
}, 0);
```

ã“ã®ãŸã‚ã€action.ts ã‚’å¤‰æ›´ã—ãŸã¨ã„ã†ã‚ã‘ã§ã™ã€‚

<Aside type="tip">
  `useFormState` ã¯ã€`useActionState` ã«ç½®ãæ›ã‚ã‚‹ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚

  ã“ã® Hands-on ä½œæˆæ™‚ç‚¹ã§ã¯ã€Next.jsã§ã®åˆ©ç”¨ã¯ã¾ã ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚ã€`useFormState` ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
  `useActionState` ãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ãŸéš›ã«ã¯ã€ãã¡ã‚‰ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
  ãã®ã¾ã¾ç½®ãæ›ãˆã‚‰ã‚Œã‚‹ã¯ãšã§ã™ã€‚

  https://github.com/facebook/react/pull/28491
</Aside>
<Aside type="tip">
  useFormState ã¨ä¼¼ã¦ã„ã‚‹ã‚‚ã®ã« useFormStatus ãŒã‚ã‚Šã¾ã™ã€‚
  useFormStatus ã¯ã€action ã®å®Ÿè¡ŒçŠ¶æ³ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

  è©³ç´°ã¯ã“ã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

  https://ja.react.dev/reference/react-dom/hooks/useFormStatus
</Aside>

## ãƒãƒ£ãƒ¬ãƒ³ã‚¸ğŸ’ª
sgin-up, login ã«æˆåŠŸã—ãŸæ™‚ã«Toastã‚’è¡¨ç¤ºã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã¾ãšã¯ã€Layout ã« `Toaster` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff lang="tsx"
// apps/workspace/app/layout.tsx
import type { Metadata } from "next";
import "./globals.css";
+import { Toaster } from "react-dom";

...
      <body>
        {children}
+       <Toaster />
      </body>

```

æ¬¡ã«ã€`action.ts`ã‚’å¤‰æ›´ã—ã¦ã€sever action ãŒæˆåŠŸã—ãŸã“ã¨ãŒã‚ã‹ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```diff lang="tsx"
// apps/workspace/app/actions.ts
...

-type State = inferFlattenedErrors<typeof authSchema> | null;
+type State = inferFlattenedErrors<typeof authSchema> | { success: true } | null;
...
  if (response.ok) {
    const result = await response.json();
    cookies().set("___Host-auth", result.message);
-    redirect("/inbox");
+    return { success: true };
  }
```

æœ€å¾Œã«ã€`sign-up-form.tsx` ã«æˆåŠŸã—ãŸæ™‚ã«Toastã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```diff lang="tsx"
// apps/workspace/app/components/sign-up-form.tsx
import { Label } from "@/components/ui/label";
+import { toast } from "@/components/ui/use-toast";
+import { useRouter } from "next/navigation";
import { useFormState } from "react-dom";
...
  const [state, formAction] = useFormState(auth, null);

+  const router = useRouter();
+  if (state && "success" in state) {
+    toast({
+      description: "ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ",
+    });
+    router.push("/inbox");
+    return;
+  }
  
  return (
```

åŒæ§˜ã®ä¿®æ­£ã‚’ `login-form.tsx` ã«ã‚‚è¡Œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ã“ã“ã¾ã§ã§ããŸã‚‰ã€`http//localhost:3000` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ç™»éŒ²ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
toast ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

## ã¾ã¨ã‚

client component ã‚’ä½¿ã£ã¦ã€ã‚¨ãƒ©ãƒ¼ã®æƒ…å ±ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãŸã€useFormState Hook ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ç°¡æ½”ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚
